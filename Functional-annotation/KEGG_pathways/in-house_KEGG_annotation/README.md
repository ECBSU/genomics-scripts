# Slurm script that utilizes EggNOG and a python script to find the completion of KEGG modules
## Info
This script allows for finding KEGG module completion without using the KEGG webserver. It circumvents
the use of blastKOALA by assessing the K terms present in the genome using EggNOG. A python script is used
to parse the KEGG definitions of each module, and to then calculate each possible combination of K terms 
that complete this module into a functional pathway. The script then assess per module which combination 
is most complete given the genome's K terms, and outputs the degree of completion. 

This script is a .slurm script that (after giving your input) can be run directly on the OIST Deigo server 
using "sbatch KEGGstand.slurm"

## Important notes: 
EggNOG appears to give more results than blastKOALA (approx. 3% more K terms). On the other hand, EggNOG can miss k terms that are found by blastKOALA. In my tests, 
roughly 8% of k terms were unique to EggNOG, 4% were unique to blastKOALA and 88% were shared. This translated to a similar ratio in module completion. 

Several KEGG modules contain "non-essential genes". While part of the module, they are not strictly required for module functionality, and thus the pipeline does not
consider them for calculating module completion (similar to KEGG's approach). Though not counted towards module completion, if non-essential genes of a module are found in the organism, 
they will be included in the output for reference. 

The script is currently incapable of interpreting the "module set" modules (M00611-M00618 and M00620). These modules contain other modules, rather than gene K terms, for which the script is not designed. These modules are thus not included in the results  

The KEGG module calculation script is currently undergoing validation. It has been tested on 50 genomes so far, corresponding to a total of 2265 modules. Given the same input, the script has identical complete modules as the KEGG webserver (with the exception of the "module set" modules mentioned above, and one mistake by KEGG) in all genomes. 

## Input
The script takes a directory as input, and analyzes each fasta file in the directory. By default it takes genome 
fasta files, but it can be modified to take CDS or protein sequences instead (which will run much faster, although they could
potentially be less sensitive). 

The input is hardcoded, so needs to be adjusted in the script itself.
Please change the following lines to suit your case:

Line 8: #SBATCH --array=x-x <-- Change the array size to fit your number of samples (0-0 = 1 sample, 0-1 = 2 samples etc)

Line 16: input_dir=/path/to/dir <-- Change the path to the path of your directory containing the fasta files

Line 17: output_dir=/path/to/dir <-- Change the path to your desired output folder (probably somewhere on /flash)

Line 18: extension=.fasta <-- Change "fasta" to the extension used in your fasta file (usually fna, faa, fa, or fasta)

Line 33: (OPTIONAL) By default, the EggNOG command will search the standard EggNOG database. If you're working with bacterial genomes, I strongly recommend changing to the bacterial database by replacing: 
/bucket/HusnikU/Databases/EggNOG_mmseqs2_databases/Standard.mmseqs/mmseqs.db --> /bucket/HusnikU/Databases/EggNOG_mmseqs2_databases/Bacteria.mmseqs/Bacteria.mmseqs 


If all variables are correct, just run the script using "sbatch KEGGstand.slurm"

## Output
The output will be generated in the specified folder. It includes the regular EggNOG output, and 2 text files generated by 
the python script. By default these are:

input_fasta.emapper.annotations_KEGG_complete_modules.tsv = Tab-delimited text file only containing the modules found to be 
100% complete. The columns from left to right are: KEGG entry, KEGG name, highest completion (as a fraction 0-1), the genes comprising the most complete pathways, and any potential non-essential genes found for the module.  

input_fasta.emapper.annotations_KEGG_completion.tsv = Tab-delimited text file showing the found completion for each KEGG
module. The columns from left to right are: KEGG entry, KEGG name, highest completion expressed as a fraction, the genes comprising the most complete pathways, and any potential non-essential genes found for the module.  
